webpackJsonp([1],{"1UK+":function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=i("BO1k"),s=i.n(n),a=i("//Fk"),r=i.n(a),c=i("otAq"),o=i("eA7o"),l={name:"ActivityEditor",props:["meta"],components:{"input-tips":c.a,"input-image":o.a},data:function(){return{usedMeta:this.meta,id:0,type:-1,title:"",inputType:1,same:0,isListEdited:!1,prev:{image:"",details:"",time:"",number:0,numberList:[]},crn:{image:"",details:"",time:"",number:0,numberList:[]},loading:!1,saved:!1}},watch:{inputType:function(){1===this.inputType&&(this.same=this.crn.numberList[0],this.toSame())}},computed:{isDetailsValid:function(){return""!==this.crn.details},isTimeValid:function(){return""!==this.time&&this.$global.compareDatetime(this.crn.time+":00")>0},isNumberValid:function(){return 0===this.type?this.isPosInt(this.crn.number)&&this.crn.number>=this.prev.number:1===this.type?this.isPosInt(this.crn.number):void 0},isSameValid:function(){return this.isPosInt(this.same)},isSumValid:function(){var t=0;return 1===this.inputType?t=10*this.same:2===this.inputType&&this.crn.numberList.forEach(function(e){""!==e&&(t+=e)}),this.isNumberValid&&t>=this.crn.number},isValid:function(){var t=this,e=t.isDetailsValid&&t.isTimeValid&&t.isNumberValid;return e?0===t.type?e:1===t.type?e&&t.isSumValid:void 0:e},edited:function(){var t=this,e=t.crn.details!==t.prev.details||t.crn.time!==t.prev.time||t.crn.number!==t.prev.number||""!==t.crn.image;return 0===t.type?e:1===t.type?e||t.isListEdited:void 0}},beforeRouteLeave:function(t,e,i){this.saved||!this.edited||confirm("确定放弃当前更改？")?(this.$emit("con-fade-out"),setTimeout(function(){i()},100)):i(!1)},beforeCreate:function(){this.$global.logined||this.$root.$router.replace("/login"),this.$global.isManager||this.$root.$router.replace("/activity/"+this.$route.params.id)},created:function(){var t=this;this.$global.logined&&this.$global.isManager&&(this.checkActivity(),setTimeout(function(){t.usedMeta.queryTypes=["修改活动"],t.usedMeta.value=0,t.usedMeta.back=t.back,t.usedMeta.flush=function(){}},100),setTimeout(function(){t.$emit("nav-fade-in")},200))},methods:{isPosInt:function(t){return""!==t&&t>0&&t%1==0},toSame:function(){var t=this;t.crn.numberList.forEach(function(e,i){t.$set(t.crn.numberList,i,t.same)})},checkList:function(){var t=this;if(1===t.type){var e=void 0;for(e=0;e<10;e++)if(t.prev.numberList[e]!==t.crn.numberList[e])return void(t.isListEdited=!0)}t.isListEdited=!1},back:function(){this.$root.$router.push("/activity/"+this.$route.params.id)},saveActivity:function(){var t,e,i=this;i.loading=!0,0===i.type?(t="/api/publisher/modify/volunteer/"+i.$route.params.id,e={details:i.crn.details,action_time:i.$global.inputToDatetime(i.crn.time),member:i.crn.number}):1===i.type&&(t="/api/publisher/modify/award/"+i.$route.params.id,e={details:i.crn.details,book_time:i.$global.inputToDatetime(i.crn.time),award:i.crn.number,member_list:i.crn.numberList}),i.$http.post(t,e).then(function(t){if((t=t.body)instanceof Object){if(!t.err_code){if(""!==i.crn.image){var e=new FormData;return e.append("image",i.image),i.$http.post("/api/publisher/modify/image/"+i.id,e)}return r.a.reject(0)}alert(t.err_msg)}else alert("服务器发生错误")}).then(function(t){return(t=t.body)instanceof Object?t.err_code?r.a.reject(t.err_msg):r.a.reject(0):r.a.reject("服务器发生错误")}).catch(function(t){i.loading=!1,0===t?(i.saved=!0,i.$root.$router.push("/activity/"+i.$route.params.id)):"string"==typeof t?alert(t):alert("404！该服务暂时不可用")})},checkActivity:function(){var t=this;t.$http.post("/api/get-activity.php",{type:0,start_id:t.$route.params.id,number:1}).then(function(e){if(!((e=e.body)instanceof Object))return r.a.reject("服务器发生错误");if(e.err_code)return r.a.reject(e.err_msg);if(!((e=e.data).activities instanceof Array&&1===e.activities.length&&e.activities[0].id===Number(t.$route.params.id)))return r.a.reject("活动不存在");var i=e.activities[0],n=!1;return 0===i.type?n=t.$global.compareDatetime(i.action_time)>0:1===i.type&&(n=t.$global.compareDatetime(i.book_time)>0),n&&i.is_publisher?(t.id=i.id,t.type=i.type,t.title=t.title=i.title,t.prev.details=t.crn.details=i.details,t.prev.image=i.image,0===t.type?(t.prev.time=t.crn.time=t.$global.datetimeToInput(i.action_time),t.prev.number=t.crn.number=i.member,r.a.reject(0)):1===t.type?(t.prev.time=t.crn.time=t.$global.datetimeToInput(i.book_time),t.prev.number=t.crn.number=i.award,t.$http.post("/api/department.php",{id:t.id})):void 0):r.a.reject("你没有修改权限")}).then(function(e){if((e=e.body)instanceof Object){if(e.err_code)return r.a.reject(e.err_msg);e=e.data,t.prev.numberList=e.member_list.slice(),t.crn.numberList=e.member_list.slice();var i=e.member_list[0],n=!0,a=!0,c=!1,o=void 0;try{for(var l,u=s()(t.crn.numberList);!(a=(l=u.next()).done);a=!0){var p=l.value;if(i!==p){t.inputType=2,n=!1;break}i=p}}catch(t){c=!0,o=t}finally{try{!a&&u.return&&u.return()}finally{if(c)throw o}}return n&&(t.same=e.member_list[0]),r.a.reject(0)}return r.a.reject("服务器发生错误")}).catch(function(e){0!==e?("string"==typeof e?alert(e):alert("服务器发生错误"),t.$root.$router.replace("/activity/"+t.$route.params.id)):setTimeout(function(){t.$emit("con-fade-in")},100)})}}},u={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{attrs:{id:"activity-editor"}},[i("div",{staticClass:"image"},[i("input-image",{attrs:{first:!1,src:t.prev.image},on:{change:function(e){t.crn.image=e}}},[i("template",{slot:"before"},[t._v("轻触以修改")]),t._v(" "),i("template",{slot:"after"},[t._v("轻触取消修改")])],2)],1),t._v(" "),i("div",{staticClass:"content"},[i("div",{staticClass:"uneditable"},[t._m(0),t._v(" "),i("div",{staticClass:"flex-value"},[0===t.type?i("div",{staticClass:"value"},[t._v("志愿者活动")]):1===t.type?i("div",{staticClass:"value"},[t._v("福利活动")]):t._e()])]),t._v(" "),i("div",{staticClass:"uneditable"},[t._m(1),t._v(" "),i("div",{staticClass:"flex-value"},[i("div",{staticClass:"value"},[t._v(t._s(t.title))])])]),t._v(" "),i("input-tips",{attrs:{"err-when":!t.isDetailsValid},model:{value:t.crn.details,callback:function(e){t.$set(t.crn,"details",e)},expression:"crn.details"}},[i("template",{slot:"title"},[t._v("详情：")]),t._v(" "),""===t.crn.details?i("span",{attrs:{slot:"tips"},slot:"tips"},[t._v("详情不能为空")]):i("span",{attrs:{slot:"tips"},slot:"tips"},[t._v("详情应不超过100字符")])],2),t._v(" "),i("input-tips",{attrs:{type:"datetime-local","err-when":!t.isTimeValid},model:{value:t.crn.time,callback:function(e){t.$set(t.crn,"time",e)},expression:"crn.time"}},[i("template",{slot:"title"},[t._v("时间：")]),t._v(" "),""===t.crn.time?i("span",{attrs:{slot:"tips"},slot:"tips"},[t._v("时间信息不全")]):i("span",{attrs:{slot:"tips"},slot:"tips"},[t._v("时间必须晚于当前")])],2),t._v(" "),i("input-tips",{attrs:{type:"number","err-when":!t.isNumberValid},model:{value:t.crn.number,callback:function(e){t.$set(t.crn,"number",t._n(e))},expression:"crn.number"}},[0===t.type?i("span",{attrs:{slot:"title"},slot:"title"},[t._v("限制人数：")]):1===t.type?i("span",{attrs:{slot:"title"},slot:"title"},[t._v("奖品总数：")]):t._e(),t._v(" "),0===t.type&&t.crn.number<t.prev.number?i("span",{attrs:{slot:"tips"},slot:"tips"},[t._v("志愿人数不应减少")]):i("span",{attrs:{slot:"tips"},slot:"tips"},[t._v("数量应为正整数")])]),t._v(" "),1===t.type?i("div",[i("input-tips",{attrs:{type:"select","err-when":!1},model:{value:t.inputType,callback:function(e){t.inputType=t._n(e)},expression:"inputType"}},[i("template",{slot:"title"},[t._v("各部门人数限制：")]),t._v(" "),i("template",{slot:"options"},[i("option",{attrs:{value:"1"}},[t._v("各部门相同")]),t._v(" "),i("option",{attrs:{value:"2"}},[t._v("自定义")])])],2),t._v(" "),1===t.inputType?i("div",[i("input-tips",{attrs:{type:"number",value:t.same,"err-when":!t.isSameValid},on:{input:function(e){t.checkList(t.toSame(t.same=Number(e)))}}},[i("span",{attrs:{slot:"title"},slot:"title"},[t._v("各个部门：")]),t._v(" "),!t.isNumberValid||t.isSumValid?i("span",{attrs:{slot:"tips"},slot:"tips"},[t._v("数量应为正整数")]):t._e()])],1):2===t.inputType?i("div",t._l(t.crn.numberList,function(e,n){return i("div",{key:"inputList"+n},[i("input-tips",{attrs:{type:"number",value:t.crn.numberList[n],"err-when":!t.isPosInt(t.crn.numberList[n])},on:{input:function(e){t.checkList(t.$set(t.crn.numberList,n,Number(e)))}}},[i("span",{attrs:{slot:"title"},slot:"title"},[t._v(t._s(t.$global.departmentList[n])+"：")]),t._v(" "),9!==n||!t.isNumberValid||t.isSumValid?i("span",{attrs:{slot:"tips"},slot:"tips"},[t._v("数量应为正整数")]):t._e()])],1)})):t._e()],1):t._e(),t._v(" "),1===t.type&&t.isNumberValid&&!t.isSumValid?i("div",{staticClass:"sum-error"},[t._v("限制总人数应不小于奖品数")]):t._e()],1),t._v(" "),i("div",{staticClass:"button-content"},[i("div",{staticClass:"button",class:{"button-dis":!t.edited||!t.isValid||t.loading},on:{click:function(e){!t.edited||!t.isValid||t.loading||t.saveActivity()}}},[i("div",{staticClass:"button-text"},[t._v("保 存")])])])])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"flex-title"},[e("div",{staticClass:"title"},[this._v("活动类型：")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"flex-title"},[e("div",{staticClass:"title"},[this._v("标题：")])])}]};var p=i("VU/8")(l,u,!1,function(t){i("Halm")},"data-v-1b37aee6",null);e.default=p.exports},"7k97":function(t,e){},BO1k:function(t,e,i){t.exports={default:i("fxRn"),__esModule:!0}},Halm:function(t,e){},RYHU:function(t,e){},eA7o:function(t,e,i){"use strict";var n=i("//Fk"),s=i.n(n),a={name:"ImageInputer",props:["first","src"],data:function(){return{inputted:!1,imageSrc:""}},created:function(){this.$emit("change","")},methods:{changeFile:function(t){var e=this;t.files.length>0&&this.readImage(t.files[0]).then(function(i){e.imageSrc=i,e.$emit("change",t.files[0]),e.inputted=!0}).catch(function(e){t.value="",alert(e)})},showImage:function(t){this.imageSrc=t},cancel:function(){this.$emit("change",""),this.imageSrc="",document.getElementById("image-inputer").value="",this.inputted=!1},readImage:function(){var t={jpeg:"/9j/4",png:"iVBORw"};return function(e){return new s.a(function(i,n){if(e.size>=204800)n("图片大小应小于200KB");else{var s=new FileReader;s.onload=function(){var e=event.target.result;!function(e){var i=e.indexOf(",")+1;for(var n in t)if(e.indexOf(t[n])===i)return n;return!1}(e)?n("图片格式应为.jpg或.png"):i(e)},s.readAsDataURL(e)}})}}()}},r={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{style:{backgroundImage:"url("+(t.first?"":t.src)+")"},attrs:{id:"image-inputer-box"}},[i("input",{attrs:{id:"image-inputer",type:"file",accept:"image/*"},on:{change:function(e){t.changeFile(e.target)}}}),t._v(" "),i("div",{staticClass:"image",style:{backgroundImage:"url("+t.imageSrc+")"}}),t._v(" "),t.inputted?i("div",{staticClass:"image cover",on:{click:t.cancel}},[i("div",{staticClass:"info"},[t._t("after")],2)]):i("label",{staticClass:"image",class:{cover:!t.first},attrs:{for:"image-inputer"}},[i("div",{staticClass:"info",class:{first:t.first}},[t._t("before")],2)])])},staticRenderFns:[]};var c=i("VU/8")(a,r,!1,function(t){i("RYHU")},"data-v-3f1a3816",null);e.a=c.exports},fxRn:function(t,e,i){i("+tPU"),i("zQR9"),t.exports=i("g8Ux")},g8Ux:function(t,e,i){var n=i("77Pl"),s=i("3fs2");t.exports=i("FeBl").getIterator=function(t){var e=s(t);if("function"!=typeof e)throw TypeError(t+" is not iterable!");return n(e.call(t))}},otAq:function(t,e,i){"use strict";var n={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"input-tips"},[i("div",{staticClass:"flex-title"},[i("div",{staticClass:"title"},[t._t("title")],2)]),t._v(" "),i("div",{staticClass:"flex-input"},[i("div",{staticClass:"input-box"},["select"!==t.type?i("input",{attrs:{type:t.type,spellcheck:"false"},domProps:{value:t.value},on:{input:function(e){t.$emit("input",e.target.value)},focus:function(e){t.inputting=!0},blur:function(e){t.inputting=!1}}}):i("select",{domProps:{value:t.value},on:{change:function(e){t.$emit("input",e.target.value)}}},[t._t("options")],2),t._v(" "),"select"===t.type?i("div",{staticClass:"select-image"}):t._e()]),t._v(" "),i("div",{staticClass:"error"},[!t.inputting&&t.errWhen?t._t("tips"):t._e()],2)])])},staticRenderFns:[]};var s=i("VU/8")({name:"InputTips",props:["value","type","errWhen"],data:function(){return{inputting:!0}}},n,!1,function(t){i("7k97")},"data-v-ea6e8846",null);e.a=s.exports}});
//# sourceMappingURL=1.989779f835f3ba617dd9.js.map